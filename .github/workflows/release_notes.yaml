name: Create Release Notes

on:
  push:
    tags:
    - 'v*'

permissions:
  contents: write

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Generate Gitmoji Categorized Release Notes
      id: notes
      run: |
        set -e
        tag="${GITHUB_REF##*/}"
        prev_tag=$(git describe --tags --abbrev=0 $tag^ 2>/dev/null || echo "")
        if [ -n "$prev_tag" ]; then
          commits=$(git log --pretty=format:"%s" ${prev_tag}..HEAD | tr -d '\r')
        else
          commits=$(git log --pretty=format:"%s" HEAD | tr -d '\r')
        fi

        declare -A regex_sections=(
          ["âœ¨ æ–°å¢"]="^(âœ¨|æ–°å¢|feat)(\\(.+\\))?([ ]|[:ï¼š][ ]?)"
          ["ğŸ©¹ ä¿®å¤"]="^(ğŸ©¹|ä¿®å¤|fix)(\\(.+\\))?([ ]|[:ï¼š][ ]?)"
          ["ğŸ“š æ–‡æ¡£"]="^(ğŸ“š|æ–‡æ¡£|docs)(\\(.+\\))?([ ]|[:ï¼š][ ]?)"
          ["ğŸ¨ é£æ ¼"]="^(ğŸ¨|é£æ ¼|style)(\\(.+\\))?([ ]|[:ï¼š][ ]?)"
          ["ğŸš€ æ€§èƒ½"]="^(ğŸš€|æ€§èƒ½|perf)(\\(.+\\))?([ ]|[:ï¼š][ ]?)"
          ["ğŸ§© é…ç½®"]="^(ğŸ§©|é…ç½®|config)(\\(.+\\))?([ ]|[:ï¼š][ ]?)"
          ["ğŸŒ è¯­è¨€"]="^(ğŸŒ|è¯­è¨€|i18n)(\\(.+\\))?([ ]|[:ï¼š][ ]?)"
          ["ğŸ€ æ‚é¡¹"]="^(ğŸ€|æ‚é¡¹|chore)(\\(.+\\))?([ ]|[:ï¼š][ ]?)"
        )

        categories=(
          "âœ¨ æ–°å¢"
          "ğŸ©¹ ä¿®å¤"
          "ğŸ“š æ–‡æ¡£"
          "ğŸ¨ é£æ ¼"
          "ğŸš€ æ€§èƒ½"
          "ğŸ§© é…ç½®"
          "ğŸŒ è¯­è¨€"
          "ğŸ€ æ‚é¡¹"
        )

        declare -A sections
        for key in "${categories[@]}"; do
          sections[$key]=""
        done

        body=""

        while IFS= read -r msg; do
          matched=false
          for category in "${!regex_sections[@]}"; do
            pattern=${regex_sections[$category]}
            if echo "$msg" | grep -Eq "$pattern"; then
              clean_msg=$(echo "$msg" | sed -E "s/$pattern//I")
              sections["$category"]+="- $clean_msg\n"
              matched=true
              break
            fi
          done

          if [ "$matched" = false ]; then
            body+="### $msg\n\n"
          fi
        done <<< "$commits"

        for key in "${categories[@]}"; do
          if [[ -n "${sections[$key]}" ]]; then
            body+="## $key\n${sections[$key]}\n"
          fi
        done

        if [ -z "$body" ]; then
          body="### æœ¬æ¬¡æ›´æ–°æœªåŒ¹é…åˆ°åˆ†ç±»çš„æäº¤è®°å½•ã€‚\n\n"
        fi

        {
          echo "result<<EOF"
          echo -e "$body"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "${{ github.ref_name }}"
        body: ${{ steps.notes.outputs.result }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
